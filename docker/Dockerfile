# Ubuntu Fitzhi container
FROM adoptopenjdk/openjdk11:armv7l-ubuntu-jre-11.0.12_7
LABEL Frederic VIDAL (frederic.vidal@fitzhi.com)

RUN apt update; \
	apt-get -y install git; \
	apt-get -y install nginx

# URL where the Sonar server is installed
ARG urlSonarServer

# First authentification credential : user/password.
# User required to be identified by Sonar. Default is "admin"
ARG user
# Password required to be identified in Sonar.
# This property is mandatory if the connection is made with the pair user/password
ARG password


# Second authentification credential : token login.
# Login token generated by the Sonar security module.
ARG login

RUN mkdir fitzhi; \
	cd fitzhi; \
	curl --insecure https://spoq.fitzhi.com/release/deploy.zip --output deploy.zip; \
	tar xvf deploy.zip; \
	cp ./deploy/docker/default /etc/nginx/sites-enabled/default; \
	cp ./deploy/docker/start-fitzhi.sh ./deploy/backend-fitzhi/start-fitzhi.sh; \
	cp ./deploy/docker/sonar-servers.json ./deploy/data/referential/sonar-servers.json; \
	cd /; \
	rm -rf spoq; \
	git clone https://github.com/fitzhi/spoq.git; \
	cd ./spoq; \
	rm -rf .git; \
	echo "test"; \
	cd ..

WORKDIR /fitzhi/deploy/backend-fitzhi

# CMD service nginx start && java -Xmx1g -jar fitzhi.jar --spring.profiles.active=HTTP > ../out.txt
EXPOSE 80
